#include "calibration.h"
#include <stdio.h>

/* ************************************************************************** */

polynomial_t calibrationBuffer[NUMBER_OF_ARRAYS][NUM_OF_BANDS];

polynomial_t const calibrationTable[NUMBER_OF_ARRAYS][NUM_OF_BANDS] = {
    {
        // Forward Power
        {0.000016, 0.048955, -7.478607}, // 01800000
        {0.000021, 0.017728, -1.724494}, // 03500000
        {0.000019, 0.018541, -2.582990}, // 07000000
        {0.000026, 0.002049, 0.888401},  // 10100000
        {0.000025, 0.003874, 0.685159},  // 14000000
        {0.000025, 0.002618, 4.270758},  // 18068000
        {0.000024, 0.005309, 0.380667},  // 21000000
        {0.000021, 0.015972, -0.860926}, // 24890000
        {0.000024, 0.008473, -1.157670}, // 28000000
        {0.000027, 0.000506, 0.392881},  // 50000000
    },
    {
        // Reverse Power
        {0.000016, 0.048955, -7.478607}, // 01800000
        {0.000021, 0.017728, -1.724494}, // 03500000
        {0.000019, 0.018541, -2.582990}, // 07000000
        {0.000026, 0.002049, 0.888401},  // 10100000
        {0.000025, 0.003874, 0.685159},  // 14000000
        {0.000025, 0.002618, 4.270758},  // 18068000
        {0.000024, 0.005309, 0.380667},  // 21000000
        {0.000021, 0.015972, -0.860926}, // 24890000
        {0.000024, 0.008473, -1.157670}, // 28000000
        {0.000027, 0.000506, 0.392881},  // 50000000
    }

};

/* ************************************************************************** */

void print_poly(polynomial_t *poly) {
    printf("A = %f\r\n", poly->A);
    printf("B = %f\r\n", poly->B);
    printf("C = %f\r\n", poly->C);
}
uint16_t bands[] = {
    1800, 3500, 7000, 10100, 14000, 18068, 21000, 24890, 28000, 50000,
};

int16_t find_closest_band_index(int16_t val1, int16_t val2, int16_t target) {
    if (target - bands[val1] >= bands[val2] - target) {
        return val2;
    } else {
        return val1;
    }
}

uint8_t decode_frequency_to_band_index(uint16_t frequency) {
    for (uint8_t i = 0; i < 9; i++) {
        if (frequency < bands[i + 1]) {
            return find_closest_band_index(i, i + 1, frequency);
        }
    }

    return 4;
}