#include "calibration.h"
#include <stdio.h>

/* ************************************************************************** */

polynomial_t calibrationBuffer[NUMBER_OF_ARRAYS][NUM_OF_BANDS];

polynomial_t const calibrationTable[NUMBER_OF_ARRAYS][NUM_OF_BANDS] = {
    {
        // Forward Power
        {2.646886752780751e-05, 0.019753925950285144, 0.5415923799922686},
        {2.2090873503127537e-05, 0.016432539422166777, -2.0363651034165513},
        {1.8414080000546962e-05, 0.025294014931961414, -7.496994220187248},
        {1.838722104025278e-05, 0.022801114767453147, -4.335002847218449},
        {2.346267891415577e-05, 0.006629454091622672, 5.23445431028034},
        {2.2547156623755794e-05, 0.010581173610835845, -0.11060844399024931},
        {2.4629034006943113e-05, 0.0049599890398325155, 0.1566186419247201},
        {2.569706787261108e-05, 0.0031523904325161107, 0.8131464253257781},
        {2.457285173784475e-05, 0.007341210803273076, -0.39793767894492554},
        {2.818090362298581e-05, -0.0020007588895786317, 0.797893909667029},
    },
    {
        // Reverse Power
        {-6.355870365353766e-08, 0.0021114947454470632, -3.3233713868199857},
        {9.636113279863712e-09, 0.0007854485017680814, -1.2897052749812759},
        {1.8870715156876166e-08, 0.00038647970077677494, 0.03783675191045503},
        {1.6609439862950562e-09, 0.000627348069279909, -0.19478443204518286},
        {6.1094139222281876e-09, 0.0006757532591031783, -1.6303894765683793},
        {3.297283980844795e-08, 0.00014622500256708984, 0.14119908969236405},
        {2.898132985637229e-08, 0.0002138129999254348, 0.7222274632903192},
        {-1.1110267881724832e-09, 0.0008039961448991979, -1.121353305635931},
        {2.338403359272727e-08, 0.00029870448117176644, 0.16868232296906882},
        {-1.795757250585787e-10, 0.00038442557892187044, 0.7334469494831403},
    }};

/* ************************************************************************** */

void print_poly(polynomial_t *poly) {
    printf("A = %f\r\n", poly->A);
    printf("B = %f\r\n", poly->B);
    printf("C = %f\r\n", poly->C);
}
uint16_t bands[] = {
    1800, 3500, 7000, 10100, 14000, 18068, 21000, 24890, 28000, 50000,
};

int16_t find_closest_band_index(int16_t val1, int16_t val2, int16_t target) {
    if (target - bands[val1] >= bands[val2] - target) {
        return val2;
    } else {
        return val1;
    }
}

uint8_t decode_frequency_to_band_index(uint16_t frequency) {
    for (uint8_t i = 0; i < 9; i++) {
        if (frequency < bands[i + 1]) {
            return find_closest_band_index(i, i + 1, frequency);
        }
    }

    return 4;
}